<?php

/**
 * @file
 * Primary module hooks for wyciwyg-utils module.
 */

use Drupal\user\Entity\User;
use Drupal\Core\Form\FormStateInterface;

 /**
 * Implements hook_entity_presave() for user entities.
 *
 * Adds the 'gamemaster' role to new users.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   The entity being saved.
 */
function wyciwyg_utils_user_presave(Drupal\Core\Entity\EntityInterface $entity) {
  if ($entity instanceof User && $entity->isNew()) {
      $entity->addRole('gamemaster');
  }
}

/**
 * Alter the input field for the Game PIN on the Challenge content type.
 */
function wyciwyg_utils_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  if ( ($form_id === 'node_challenge_form' || $form_id === 'node_challenge_edit_form') && !empty($form['field_game_pin']['widget'][0]['value'])) {
    // Get the current PIN value
    $current_value = $form['field_game_pin']['widget'][0]['value']['#default_value'] ?? '';

    // Generate a new PIN only if it's empty
    if (empty($current_value)) {
      $new_pin = generate_unique_game_pin();
      $form['field_game_pin']['widget'][0]['value']['#default_value'] = $new_pin;
    }

    // Set attributes for validation
    $attributes = [
      'pattern' => '[A-Z0-9]{6,}', 
      'title' => 'Game PIN must be at least 6 characters long and contain only uppercase letters and numbers.',
      'oninput' => "this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '')",
    ];

    $form['field_game_pin']['widget'][0]['value']['#attributes'] = array_merge(
      $form['field_game_pin']['widget'][0]['value']['#attributes'] ?? [],
      $attributes
    );
  }
}

/**
 * Generate a unique 6-character game PIN.
 *
 * @return string
 *   A unique uppercase alphanumeric game PIN.
 */
function generate_unique_game_pin() {
  do {
    $pin = strtoupper(substr(str_shuffle('ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 6));
  } while (game_pin_exists($pin)); // Ensure uniqueness

  return $pin;
}

/**
 * Check if a game PIN already exists in the database.
 *
 * @param string $pin
 *   The generated PIN to check.
 *
 * @return bool
 *   TRUE if the PIN already exists, FALSE otherwise.
 */
function game_pin_exists($pin) {
  $query = \Drupal::entityQuery('node')
    ->condition('type', 'challenge')
    ->condition('field_game_pin', $pin)
    ->accessCheck(FALSE) // Explicitly disable access check to avoid QueryException
    ->range(0, 1);
  
  return (bool) $query->execute();
}
